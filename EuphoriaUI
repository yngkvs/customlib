local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local Http = game:GetService("HttpService")
local Stats = game:GetService("Stats")
local Drawing = getgenv().Drawing or Drawing
local writefile = writefile
local readfile = readfile
local isfile = isfile
local setclipboard = setclipboard
local floor = math.floor
local clamp = math.clamp
local abs = math.abs
local Vector2_new = Vector2.new
local Color3_new = Color3.fromRGB
local now = os.clock
local Library = {}
local EventBus = {}
local Animator = {}
local Theme = {}
local Store = {}
local Input = {}
local Config = {}
local Layout = {}
local Util = {}
local elements = {}
local heartbeat_listeners = {}
local invalidate_queue = {}
local dragging = nil
local mouse = Vector2_new(0,0)
local mouse_down = false
local active_keybind = nil
local zindex_seed = 10
local function z() zindex_seed+=1 return zindex_seed end
local function ev() return {h={},on=function(self,n,f) local t=self.h[n] if not t then t={} self.h[n]=t end t[#t+1]=f return function() for i=#t,1,-1 do if t[i]==f then table.remove(t,i) break end end end end,emit=function(self,n,...) local t=self.h[n] if not t then return end for i=1,#t do local f=t[i] if f then f(...) end end end} end
local function mk(type) local o=Drawing.new(type) o.Visible=false o.ZIndex=z() return o end
local function mktext() local t=Drawing.new("Text") t.Visible=false t.ZIndex=z() return t end
local function rect(x,y,w,h,c,a,fill) local r=mk("Square") r.Position=Vector2_new(x,y) r.Size=Vector2_new(w,h) r.Color=c r.Transparency=a r.Filled=fill return r end
local function line(x1,y1,x2,y2,c,a,th) local l=mk("Line") l.From=Vector2_new(x1,y1) l.To=Vector2_new(x2,y2) l.Color=c l.Transparency=a l.Thickness=th return l end
local function text(x,y,s,c,msg,center) local t=mktext() t.Position=Vector2_new(x,y) t.Size=s t.Color=c t.Text=msg t.Center=center or false t.Outline=true return t end
local function show(o) o.Visible=true return o end
local function hide(o) o.Visible=false return o end
local function destroy(o) if o then o.Visible=false o:Remove() end end
local function uid() return Http:GenerateGUID(false) end
local function json(v) return Http:JSONEncode(v) end
local function parse(v) return Http:JSONDecode(v) end
local function schedule(f) invalidate_queue[#invalidate_queue+1]=f end
local function hb(fn) heartbeat_listeners[#heartbeat_listeners+1]=fn end
EventBus.new = function() return ev() end
Animator.new = function() local self={anims={},last=now()} hb(function(dt) for i=#self.anims,1,-1 do local a=self.anims[i] if a then local t=now() local p=(t-a.t0)/a.d if p>=1 then a.set(a.to) table.remove(self.anims,i) if a.done then a.done() end else local q=a.e(p) local v=a.from+(a.to-a.from)*q a.set(v) end end end) return self end
Animator.add = function(self,from,to,dur,set,ease,done) self.anims[#self.anims+1]={from=from,to=to,d=dur,set=set,e=ease or function(x) return x end,t0=now(),done=done} end
Theme.new = function() local self={tokens={bg=Color3_new(20,20,22),panel=Color3_new(25,26,28),accent=Color3_new(70,200,150),text=Color3_new(220,220,220),muted=Color3_new(140,140,150),shadow=Color3_new(0,0,0),alpha=0.95},bus=ev()} return self end
Theme.set = function(self,k,v) self.tokens[k]=v self.bus:emit("theme",k,v) end
Store.new = function(init) local self={state=init or {},bus=ev()} return self end
Store.set = function(self,k,v) self.state[k]=v self.bus:emit("set",k,v) end
Store.patch = function(self,t) for k,v in pairs(t) do self.state[k]=v self.bus:emit("set",k,v) end end
Store.get = function(self,k) return self.state[k] end
Input.init = function() hb(function() mouse=UIS:GetMouseLocation() end) UIS.InputBegan:Connect(function(i,g) if g then return end if i.UserInputType==Enum.UserInputType.MouseButton1 then mouse_down=true elseif i.UserInputType==Enum.UserInputType.Keyboard then active_keybind=i.KeyCode end end) UIS.InputEnded:Connect(function(i,g) if g then return end if i.UserInputType==Enum.UserInputType.MouseButton1 then mouse_down=false elseif i.UserInputType==Enum.UserInputType.Keyboard then if active_keybind==i.KeyCode then active_keybind=nil end end end) end
Config.new = function(ns) local self={ns=ns or "uilibrary",bus=ev()} return self end
Config.save = function(self,name,data) local ok=false local p=self.ns.."__"..name..".json" local s=json(data) if writefile then writefile(p,s) ok=true elseif setclipboard then setclipboard(s) ok=true end self.bus:emit("save",name,ok) return ok end
Config.load = function(self,name) local p=self.ns.."__"..name..".json" if isfile and isfile(p) and readfile then local s=readfile(p) return parse(s) end return nil end
Util.point_in_rect = function(px,py,x,y,w,h) return px>=x and py>=y and px<=x+w and py<=y+h end
Layout.new = function() local self={x=80,y=80,w=720,h=420,pad=10} return self end
local function base_element(self) self.id=uid() self.visible=true self.children={} self.bus=ev() self.destroyed=false function self:add(child) self.children[#self.children+1]=child return child end function self:mount() self.visible=true self.bus:emit("mount") end function self:unmount() self.visible=false self.bus:emit("unmount") end function self:destroy() if self.destroyed then return end self.destroyed=true self.bus:emit("destroy") for i=1,#self.children do local c=self.children[i] if c and c.destroy then c:destroy() end end end return self end
local function click_area(x,y,w,h,cb) hb(function() if mouse_down and Util.point_in_rect(mouse.X,mouse.Y,x,y,w,h) then cb() end end) end
Library.new = function() local lib={theme=Theme.new(),store=Store.new(),anim=Animator.new(),input=Input,config=Config.new("uilibrary"),layout=Layout.new(),bus=ev()} Input.init() return lib end
Library.window = function(lib,title) local L=lib.layout local win={x=L.x,y=L.y,w=L.w,h=L.h,drag=false} base_element(win) local bg=rect(win.x,win.y,win.w,win.h,lib.theme.tokens.bg,lib.theme.tokens.alpha,true) local outline=line(win.x,win.y,win.x+win.w,win.y+win.h,lib.theme.tokens.shadow,0.6,1) local hdr=text(win.x+16,win.y+12,16,lib.theme.tokens.text,title,true) hdr.Center=false bg.Visible=true outline.Visible=true hdr.Visible=true hb(function() if win.drag then bg.Position=Vector2_new(win.x,win.y) bg.Size=Vector2_new(win.w,win.h) outline.From=Vector2_new(win.x,win.y) outline.To=Vector2_new(win.x+win.w,win.y+win.h) hdr.Position=Vector2_new(win.x+16,win.y+12) end end) click_area(win.x,win.y,win.w,24,function() if dragging==nil then dragging=true local ox=mouse.X-win.x local oy=mouse.Y-win.y hb(function() if dragging and mouse_down then win.x=mouse.X-ox win.y=mouse.Y-oy else dragging=nil end end) end end) function win:create_panel(name) local p={name=name,x=win.x+12,y=win.y+40,w=floor((win.w-36)/2),h=win.h-52} base_element(p) local pr=rect(p.x,p.y,p.w,p.h,lib.theme.tokens.panel,lib.theme.tokens.alpha,true) local pt=text(p.x+10,p.y+8,14,lib.theme.tokens.muted,name,false) pr.Visible=true pt.Visible=true function p:add_section(title) local s={title=title,x=p.x+10,y=p.y+30,w=p.w-20,h=120} base_element(s) local sr=rect(s.x,s.y,s.w,s.h,lib.theme.tokens.bg,0.7,true) local st=text(s.x+6,s.y+6,14,lib.theme.tokens.text,title,false) sr.Visible=true st.Visible=true function s:add_toggle(label,init) local t={value=init and true or false,x=s.x+8,y=s.y+30,w=s.w-16,h=22} base_element(t) local tr=rect(t.x,t.y,t.w,t.h,lib.theme.tokens.panel,0.9,true) local ind=rect(t.x+4,t.y+4,14,14,lib.theme.tokens.accent, t.value and 0.9 or 0.2,true) local tt=text(t.x+26,t.y+5,14,lib.theme.tokens.text,label,false) tr.Visible=true ind.Visible=true tt.Visible=true click_area(t.x,t.y,t.w,t.h,function() t.value=not t.value ind.Transparency=t.value and 0.9 or 0.2 t.bus:emit("change",t.value) end) function t:set(v) t.value=v ind.Transparency=v and 0.9 or 0.2 t.bus:emit("change",v) end s.y=s.y+26 s.h=s.h+26 s.children[#s.children+1]=t return t end
function s:add_slider(label,min,max,init) local sl={value=init or min,min=min,max=max,x=s.x+8,y=s.y+30,w=s.w-16,h=26} base_element(sl) local sr=rect(sl.x,sl.y,sl.w,sl.h,lib.theme.tokens.panel,0.9,true) local bar=rect(sl.x+8,sl.y+18,sl.w-16,4,lib.theme.tokens.muted,0.8,true) local knob=rect(sl.x+8,sl.y+16,12,8,lib.theme.tokens.accent,0.9,true) local st=text(sl.x+8,sl.y+6,14,lib.theme.tokens.text,label,false) sr.Visible=true bar.Visible=true knob.Visible=true st.Visible=true local function set_from_mouse() local rx=clamp(mouse.X-(sl.x+8),0,sl.w-16) local v=min+(max-min)*(rx/(sl.w-16)) sl.value=v knob.Position=Vector2_new(sl.x+8+rx,sl.y+16) sl.bus:emit("change",v) end click_area(sl.x,sl.y,sl.w,sl.h,set_from_mouse) function sl:set(v) local p=(v-min)/(max-min) local rx=floor((sl.w-16)*p) sl.value=v knob.Position=Vector2_new(sl.x+8+rx,sl.y+16) sl.bus:emit("change",v) end s.y=s.y+32 s.h=s.h+32 s.children[#s.children+1]=sl return sl end
function s:add_button(label) local b={x=s.x+8,y=s.y+30,w=80,h=24} base_element(b) local br=rect(b.x,b.y,b.w,b.h,lib.theme.tokens.accent,0.85,true) local bt=text(b.x+10,b.y+5,14,lib.theme.tokens.text,label,false) br.Visible=true bt.Visible=true click_area(b.x,b.y,b.w,b.h,function() b.bus:emit("click") end) s.y=s.y+30 s.h=s.h+30 s.children[#s.children+1]=b return b end
function s:add_dropdown(label,opts,init) local d={x=s.x+8,y=s.y+30,w=s.w-16,h=24,options=opts or {},value=init or (opts and opts[1])} base_element(d) local dr=rect(d.x,d.y,d.w,d.h,lib.theme.tokens.panel,0.9,true) local dt=text(d.x+10,d.y+5,14,lib.theme.tokens.text,label..": "..tostring(d.value or ""),false) dr.Visible=true dt.Visible=true click_area(d.x,d.y,d.w,d.h,function() local i=1 for j=1,#d.options do if d.options[j]==d.value then i=j break end end i=i%#d.options+1 d.value=d.options[i] dt.Text=label..": "..tostring(d.value) d.bus:emit("change",d.value) end) s.y=s.y+30 s.h=s.h+30 s.children[#s.children+1]=d return d end
return s end
return p end
function win:destroy() destroy(bg) destroy(outline) destroy(hdr) for i=1,#self.children do local c=self.children[i] if c and c.destroy then c:destroy() end end end
return win end
RS.Heartbeat:Connect(function(dt) for i=1,#invalidate_queue do local f=invalidate_queue[i] if f then f() end end invalidate_queue={} for i=1,#heartbeat_listeners do local f=heartbeat_listeners[i] if f then f(dt) end end end)
function Library:CreateWindow(opts)
    local lib = Library.new()
    local title = (opts and opts.Title) or "Window"
    local win = Library.window(lib, title)
    if opts and opts.Center then
        local cam = workspace.CurrentCamera
        if cam then
            local v = cam.ViewportSize
            win.x = floor(v.X/2 - lib.layout.w/2)
            win.y = floor(v.Y/2 - lib.layout.h/2)
        end
    end
    win.Tabs = {}
    win._tab_y = win.y + 40
    function win:AddTab(name)
        local label = text(win.x + 12, win._tab_y, 16, lib.theme.tokens.muted, name, false)
        label.Visible = true
        self.Tabs[name] = { Name = name, _label = label }
        win._tab_y = win._tab_y + 22
        return self.Tabs[name]
    end
    if opts and opts.AutoShow == false then
        local function setVisible(v)
            for _, t in pairs({}) do end
        end
    end
    return win
end
return Library
